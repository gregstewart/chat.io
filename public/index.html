<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>chat.io</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
    <script src="http://localhost:8080/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="js/underscore-min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var socket = new io.Socket('localhost', {port: 8080});
        var isConnected = socket.connect();
        var you = '';

        function getFormattedDate() {
            var date = new Date();
            return ' [ ' + date.getFullYear() + '/' + date.getMonth() + '/' + date.getDate() + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + ' ]';
        }

        function displayOverlay() {
            // http://stackoverflow.com/questions/965662/using-jquery-to-create-overlay-but-content-inherits-css-opacity-can-you-help
            $(document.body).prepend('<div class="modal-overLay"></div>');
            $('.modal-overLay').css({ 'background-color': '#000',
                opacity: 0.5,
                position:'fixed',
                top:0,
                left:0,
                width:'100%',
                height:'100%',
                'text-align':'center',
                'vertical-align':'middle'
            });

            $('.modal-overLay').fadeIn('slow');
            $('#login-container').css({
                position: 'absolute',
                left: '30%',
                top: '5%'
            });
            $('#login-container').fadeIn(500);
        }

        function captureHandle() {
            var handle = $('input#handle').val();

            if (handle !== '') {
                you = handle;
                $.ajax({
                    type: 'post',
                    url: '/user/new',
                    data: 'handle=' + handle + '&sessionid=' + isConnected.transport.sessionid,
                    dataType: 'json',
                    success: function(response) {

                        if (response.error !== null) {
                            alert('There\'s been an error, sorry unable to store handle');
                        } else {
                            $('#login-container').hide();
                            $('.modal-overLay').fadeOut(500);
                            insertMessage(you, 'has connected');
                            getLoggedInUsers();
                        }
                    }
                });

            } else {
                alert('Please enter a handle.');
            }
        }

        function getLoggedInUsers() {
            $.ajax({
                type: 'get',
                url: '/user/',
                dataType: 'json',
                success: function(response) {

                    if (response.error !== null) {
                        alert('There\'s been an error, sorry unable to store handle');
                    } else if (response.users.length > 0) {
                        var users = response.users;
                        _.each(users,function(i) {
                            $('ul#loggedin-users').append('<li>' + i.handle + '</li>');
                        });
                    }
                }
            });
        }

        function sendMessage() {
            var message = $('input#shout-box').val();
            insertMessage(you, message);
            socket.send(message);
        }

        function insertMessage(user, message, type) {
            if (!typeof type === 'undefined') {

            }

            $('ul#message-list').prepend('<li>' + user + ' ' + getFormattedDate() + ' : ' + message + '</li>');
        }

        if (isConnected) {
            $('input#btn-send').click(function() {
                sendMessage();
            });

            $('input#shout-box').keydown(function(event) {
                if (event.keyCode == '13') {
                    event.preventDefault();
                    sendMessage();
                }
            });

            socket.on('connect', function(data) {
                console.log('connect');
            });

            socket.on('message', function(data) {
                data = JSON.parse(data);
                insertMessage(data.id, data.message);
            });

            socket.on('disconnect', function() {
                $.ajax({
                    type: 'get',
                    url: '/delete/',
                    dataType: 'json',
                    data: 'handle=' + you + '&sessionid=' + isConnected.transport.sessionid,
                    success: function(response) {
                        console.log('disconnect');
                    }
                });
            });
        }
    </script>
    <link rel="css/reset.css" media="screen" type="text/css" />
    <style media="screen" type="text/css">
        body {
            margin: 0;
            padding: 0;
        }

        #login-container {
            position: absolute;
            display: none;
            background-color: #69D2E7;
            border-bottom: 2px solid #A7DBD8;
            color: #E0E4CC;
            padding: 2em;
            font-size: 1em;
            font-weight: bold;
        }

        #header {
            background-color: #FA6900;
            border-bottom: 2px solid #F38630;
            color: #fff;
            padding-left: 1em;
        }
            #header h1 {
                background-color: #FA6900;
                color: #E0E4CC;
                padding: 0.90em 1em 0 0;
                margin: 0em;
                font-size: 2em;
            }

            #header p {

            }

        #main-content {
            border-top: 2px solid #E0E4CC;
            background-color: #fff;
        }
            #main-content #input-box
            {
                margin: 1em 0.5em;
                padding: 1em;
                background-color: #69D2E7;
                border-bottom: 2px solid #A7DBD8;
                color: #E0E4CC;
                font-size: 1em;
                font-weight: bold;
            }

            #main-content hr {
                margin: 1em 0.5em;
                background-color: #69D2E7;
                border-top:0;
                border-bottom: 2px solid #A7DBD8;
            }

            #main-content #message-box {
                border: #A7DBD8 1px solid;
                height: 100px;
                overflow: auto;
                margin: 1em 0.5em;
            }
    </style>
</head>
<body>

<div id="login-container">
    <label for="handle">Handle: </label>
    <input type="text" id="handle" value=""/>
    <input type="button" value="submit" id="btn-handle"/>
</div>

<div id="header">
    <h1>Chat.io</h1>
    <p>A simple chat app powered by Node.js</p>
</div>

<div id="main-content">

    <div id="input-box">
        <form action="../" method="post" enctype="application/x-www-form-urlencoded">
            <label for="shout-box">message: </label> <input type="text" id="shout-box" value=""/>
            <input type="button" value="send" id="btn-send"/>
        </form>
    </div>

    <hr/>

    <div id="message-box">
        <ul id="message-list">
        </ul>
    </div>

    <ul id="loggedin-users">
    </ul>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        displayOverlay();

        $('input#handle').focus();
        $('input#btn-handle').click(function() {
            captureHandle();
        });

        $('input#handle').keydown(function(event) {
            if (event.keyCode == '13') {
                event.preventDefault();
                captureHandle();
            }
        });
    });
</script>

</body>
</html>